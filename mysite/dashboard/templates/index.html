<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>만개의 레시피 재료 분석</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Bootstrap icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lumen/bootstrap.min.css" />
    <!-- Chart Js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- WordCloud -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
  </head>
  <style>
    /* Custom scrollbar */
    .col-md-3::-webkit-scrollbar {
      width: 10px;
    }
    
    .col-md-3::-webkit-scrollbar-thumb {
      background-color: #3cb44b;
      border-radius: 10px;
      border: 2px solid #ffffff;
    }
    
    .col-md-3::-webkit-scrollbar-track {
      background-color: #f1f1f1;
      border-radius: 10px;
    }
    
    .img-fluid:hover {
      transform: scale(1.1); /* 살짝 확대 */
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3); /* 그림자 더 강하게 */
      transition: transform 0.3s ease, box-shadow 0.3s ease; /* 부드러운 전환 */
    }
    
    /* 링크 텍스트 색상 변경 */
    .recipe-container:hover .rank-title a {
      color: #3cb44b; /* 텍스트 색상을 초록색으로 변경 */
      text-decoration: underline; /* 밑줄 추가 */
    }
  </style>
  <body>
    <!-- Navigation -->

    {% block navbar %}
      {% include 'header.html' %}
    {% endblock %}

    <section class="py-5">
      <div class="container px-4 px-lg-5 my-5">
        <div class="row">
          <!-- 왼쪽 영역: Bar Chart, Doughnut Chart, WordCloud -->
          <div class="col-md-9">
            <div class="row gx-4 gx-lg-5 align-items-start">
              <!-- align-items-start 추가 -->
              <div class="col-md-12">
                <!-- Bar Plot -->
                <div style="border: 2px solid #3cb44b; border-radius: 15px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2); padding: 10px; margin-bottom: 20px;">
                  <h5 style="text-align: center; margin: 10px 0; font-weight: bold; top: 0; background-color: white; z-index: 10; font-family: 'Noto Sans KR', sans-serif; font-weight: bold; color: #3cb44b;">많이 이용한 재료!</h5>
                  <canvas id="barChart" width="400" height="200"></canvas>
                </div>

                <!-- Doughnut Chart -->
                <div style="border: 2px solid #3cb44b; border-radius: 15px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2); padding: 10px; margin-top: 20px;">
                  <h5 style="text-align: center; margin: 10px 0; font-weight: bold; top: 0; background-color: white; z-index: 10; font-family: 'Noto Sans KR', sans-serif; font-weight: bold; color: #3cb44b;">조리 소요 시간!</h5>
                  <canvas id="piChart" width="400" height="200"></canvas>
                </div>

                <!-- Word Cloud -->
                <div id="wordcloud" style="height: 300px; width: 100%; margin-top: 20px; margin-bottom: 20px; border: 2px solid #3cb44b; border-radius: 15px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2); overflow: hidden;"></div>
              </div>
            </div>
          </div>
          <!-- 오른쪽 영역: 레시피 랭킹 -->
          <div class="col-md-3" style="height: 1165px; overflow-y: auto; position: relative; padding: 0px; border: 2px solid #3cb44b; border-radius: 15px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);">
            <h2 class="text-center mb-3" style="position: sticky; top: 0; background-color: white; z-index: 10; font-family: 'Noto Sans KR', sans-serif; font-weight: bold; color: #3cb44b; padding: 10px; border-bottom: 1px solid #3cb44b;">레시피 랭킹</h2>

            {% for recipe in recipes %}
              <div class="mb-4 recipe-container" style="padding: 10px; font-family: 'Noto Sans KR', sans-serif;">
                <div class="rank-title" style="font-weight: bold; font-size: 1.4rem; color: #333333; padding-bottom: 5px;">
                  <a href="{% url 'dashboard:recipe_detail' recipe.id %}" style="color: #333333; text-decoration: none;">{{ forloop.counter }}위: {{ recipe.recipe_title }}</a>
                </div>
                <div class="text-center">
                  <a href="{% url 'dashboard:recipe_detail' recipe.id %}"><img src="{{ recipe.image_url }}" alt="{{ recipe.recipe_title }}" class="img-fluid" style="width: 250px; height: 180px; object-fit: cover; border: 1px solid #dddddd; border-radius: 10px; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);" /></a>
                </div>
              </div>
              <div style="border-bottom: 1px solid #cccccc; margin: 0 20px;" class="mb-3"></div>
            {% endfor %}
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="py-3 bg-dark">
      <div class="container">
        <p class="m-0 text-center text-white">재형 효정 주호</p>
      </div>
    </footer>

    <script> 
    {% comment %} WordCloud {% endcomment %}
    document.addEventListener('DOMContentLoaded', function() {
        const ingredients = {{ ingredients_json|safe }};
                                
        const frequencies = ingredients.map(ing => ing.frequency);
        const maxFreq = Math.max(...frequencies);
        const minFreq = Math.min(...frequencies);
                                
        const linearScale = (val, minVal, maxVal, newMin, newMax) => {
            return newMin + (val - minVal) * (newMax - newMin) / (maxVal - minVal);
        };

        // 단어 목록을 생성하고 빈도를 스케일링합니다
        const words = ingredients.map(ingredient => [
                                        ingredient.name,
                                        Math.max(5, Math.floor(linearScale(ingredient.frequency, minFreq, maxFreq, 10, 80))) // 크기 범위를 더 넓힘
                                    ]);

        console.log("Words for WordCloud:", words); // 디버깅을 위해 콘솔에 출력
    
        // 형형색색의 팔레트 생성
        const colors = ['#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080', '#ffffff', '#000000'];
                                
        WordCloud(document.getElementById('wordcloud'), {
            list: words,
            gridSize: 10, // 글자 간격을 조금 더 조밀하게
            weightFactor: 2.2, // 빈도에 따른 크기 차이를 더 극적으로 조정
            fontFamily: 'Noto Sans KR, sans-serif',
            color: function() {
                return colors[Math.floor(Math.random() * colors.length)]; // 랜덤 색상
                },
            backgroundColor: 'white',
            rotateRatio: 0.5, // 회전 비율
            rotationSteps: 0, // 회전 각도
            drawOutOfBound: false, // 경계를 벗어나지 않도록 설정
            shrinkToFit: true, // 컨테이너에 맞추어 크기 조절
            minSize: 10
        });
    });

    {% comment %} 많이 사용한 재료 {% endcomment %}
    var canvasB = document.getElementById("barChart");
    const ctx = document.getElementById('barChart').getContext('2d');
    const barChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ labels_json|safe }},
            datasets: [{
                label: '레시피 수',
                data: {{ data_json|safe }},
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                hoverBackgroundColor: 'rgba(220, 0, 0, 0.7)',
                hoverBorderColor: 'rgba(220, 0, 0, 0.7)',
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    canvasB.onclick = function(e) {
        var slice = barChart.getElementAtEvent(e);
        if (!slice.length) return; // return if not clicked on slice
        var label = slice[0]._model.label;
        var url = "{% url 'dashboard:recipe_search' 'search_type' 'label_placeholder' %}"
        url = url.replace('search_type', encodeURIComponent('ingredient'));
        url = url.replace('label_placeholder', encodeURIComponent(label));
        window.location.href = url;
      }

    {% comment %} 조리 소요 시간 {% endcomment %}
    var canvasP = document.getElementById("piChart");
    const ctx2 = document.getElementById('piChart').getContext('2d');
    const piChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: {{ cook_time_label|safe }},
            datasets: [{
                data: {{ cook_time_data|safe }},
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)'
                    ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                    ],
                hoverBackgroundColor : [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                    ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top' // 범례의 위치 설정
                    }
                }
            }
        });
      canvasP.onclick = function(e) {
        var slice = piChart.getElementAtEvent(e);
        if (!slice.length) return; // return if not clicked on slice
        var label = slice[0]._model.label;
        var url = "{% url 'dashboard:recipe_search' 'search_type' 'label_placeholder' %}"
        url = url.replace('search_type', encodeURIComponent('time'));
        url = url.replace('label_placeholder', encodeURIComponent(label));
        window.location.href = url;
      }
   </script>
  </body>
</html>
